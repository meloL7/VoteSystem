function saveQuery(a,b){var e,c=getQueryCond(),d="";"100"==a?d="&share=1":a&&(d="&s="+a),e="",queryName&&(e="&name="+encodeURIComponent(queryName.replace(")","）"))),b&&(d+="&isreport=1"),PDF_launch("/wjx/activitystat/savereport.aspx?activity="+activityId+e+"&type=1"+d+"&qCond="+c[0]+"&econd="+c[1],420,100)}function toCheck(a){if(!a.value){var b=a.parentNode.ddlQuery;htCheckQs[b.value]="1",showCondition.call(b)}}function showCondition(){var d,e,f,g,h,i,k,l,m,n,o,p,a=this.value,b=this,c=this.spanCondition||document.createElement("span");if(c.innerHTML="",parseInt(a)==a){if(d=this.selectedIndex,e=qsQuery[d],f=e.split("§"),g="",e){if(htCheckQs[a]){for(h=0;h<f.length;h++)i=h+1,k=f[h],g+="<input type='checkbox' value='"+i+"'/><span>"+k+"</span>",0==i%3&&h<f.length-1&&(g+="<br/>");c.style.verticalAlign="top",c.style.lineHeight="22px"}else{for(g="<select id='sel"+d+"'  style='width:270px;' onchange='toCheck(this);'>",h=0;h<f.length;h++)i=h+1,k=f[h],g+="<option value='"+i+"'>"+k+"</option>";g+="<option value='-3'>(跳过)</option>",g+="<option value='-2'>(空)</option>",g+="<optgroup label='---------------------'>",g+="<option value=''>合并多个选项的数据</option>",g+="<optgroup>",g+="</select>",c.style.verticalAlign="",c.style.lineHeight=""}c.innerHTML=g}else l=this.options[this.selectedIndex],m=l.getAttribute("isdigit"),htQuestion[a]="1",m?(c.appendChild(document.getElementById("spanEntry").cloneNode(!0)),n=c.getElementsByTagName("select")[0],n.onchange=function(){var a=this.parentNode.getElementsByTagName("label")[0];a.style.display="3"==this.value?"":"none"},n.onchange(),htQuestion[a]="2"):c.appendChild(document.getElementById("spanQuestion").cloneNode(!0));c.ddlQuery=b}else switch(a){case"省份":ddlProvince.dataLoaded?c.appendChild(ddlProvince).cloneNode(!0):loadJoinData(c,ddlProvince,1);break;case"来源":ddlSource.dataLoaded?c.appendChild(ddlSource).cloneNode(!0):loadJoinData(c,ddlSource,3);break;case"城市":ddlCity.dataLoaded?c.appendChild(ddlCity).cloneNode(!0):loadJoinData(c,ddlCity,2);break;case"常用备注":if(ddlCommonNote.dataLoaded){if(ddlCommonNote.noData){alert("提示：没有添加常用备注，无法根据此条件查询！");break}c.appendChild(ddlCommonNote).cloneNode(!0)}else loadJoinData(c,ddlCommonNote,4);break;case"星标":case"支付状态":c.appendChild(ddlStar).cloneNode(!0);break;case"IP地址":case"核销码":case"完成凭证":case"用户名":case"来源详情":"IP地址"==a||"用户名"==a?(o=document.getElementById("spanInclude").cloneNode(!0),o.innerHTML="等于",c.appendChild(o)):"来源详情"==a&&(o=document.getElementById("spanInclude").cloneNode(!0),o.innerHTML="包含",c.appendChild(o)),c.appendChild(document.getElementById("spanEntry").cloneNode(!0)),c.getElementsByTagName("select")[0].style.display="none",c.getElementsByTagName("label")[0].style.display="none";break;case"提交答卷日期":case"填写所用时间":case"填写序号":case"分数":c.appendChild(document.getElementById("spanEntry").cloneNode(!0)),n=c.getElementsByTagName("select")[0],n.onchange=function(){var a=this.parentNode.getElementsByTagName("label")[0];a.style.display="3"==this.value?"":"none"},n.onchange()}this.parentNode.parentNode.insertBefore(c,this.btnDelteQuery.parentNode),this.spanCondition=c,p=c.getElementsByTagName("input"),p[0]&&"checkbox"!=p[0].type&&(p[0].value="",p[0].checkType=a,p[0].onkeydown=doEnterQuery,"提交答卷日期"==a?(p[0].onclick=function(a){calendar.show(this,null,window.event||a)},p[0].onchange=p[0].onblur=null):(p[0].onchange=p[0].onblur=checkData,p[0].onclick=null),p[1]&&"checkbox"!=p[1].type&&(p[1].checkType=a,p[1].value="",p[1].onkeydown=doEnterQuery,"提交答卷日期"==a?(p[1].onclick=function(a){calendar.show(this,null,window.event||a)},p[1].onchange=p[0].onblur=null):(p[1].onchange=p[0].onblur=checkData,p[1].onclick=null)))}function loadJoinData(a,b,c){var e,f,g,h,i,d=loadData(c);if(!d)return alert("提示：没有添加常用备注，无法根据此条件查询！"),b.dataLoaded=!0,b.noData=!0,void 0;if(e=d.split("§"),!b.dataLoaded){for(f=0;f<e.length;f++)g=e[f],h=e[f],(3==c||4==c)&&(i=e[f].split("["),g=i[0],2==i.length&&(h=i[1].replace("]",""))),b.options.add(new Option(h,g));b.dataLoaded=!0}a.appendChild(b).cloneNode(!0)}function doEnterQuery(a){return a=window.event||a,13==a.keyCode?(btnQueryClick(),a.returnValue=!1,!1):void 0}function BindQsChoiceData(a,b){var c,d,e,f,g,h;if(b)if(c=b.split("┋"),c.length>1){for(htCheckQs[a.value]="1",a.onchange(),d=new Object,e=0;e<c.length;e++)d[c[e]]="1";for(f=a.spanCondition.getElementsByTagName("input"),g=0;g<f.length;g++)h=f[g],d[h.value]&&(h.checked=!0)}else a.onchange(),a.spanCondition.getElementsByTagName("select")[0].value=b}function BindQsQuestionData(a,b){var c,d;a.onchange(),c=a.spanCondition.getElementsByTagName("input"),c[0].value=b[1]||"",c[1]&&b[3]&&(c[1].value=b[3]),b[2]||(b[2]="0"),d=a.spanCondition.getElementsByTagName("select")[0],d.value=b[2].split(";")[0],d.onchange&&d.onchange()}function isQuestion(a){return a.split("§").length>=2}function initQuery(){var a,b,c,d,e,f,g,h;if(ddlQuery.onchange=showCondition,ddlQuery.btnAddQuery=btnAddQuery,ddlQuery.btnDelteQuery=btnDelQ,btnAddQuery.onclick=addQuery,btnDelQ.onclick=function(){delQuery(ddlQuery.parentNode.parentNode,ddlQuery)},ddlQueries.push(ddlQuery),1==reportType&&(qCond||eCond)){if(a=!0,qCond)for(b=qCond.split("〒"),c=isQuestion(b[0]),c?(d=b[0].split("§"),ddlQuery.value=d[0],BindQsQuestionData(ddlQuery,d)):(d=b[0].split(","),ddlQuery.value=d[0],BindQsChoiceData(ddlQuery,d[1])),a=!1,e=1;e<b.length;e++)c=isQuestion(b[e]),c?(d=b[e].split("§"),addQuery(d[0],d)):(d=b[e].split(","),addQuery(d[0],d[1]));if(eCond)for(f=eCond.split("〒"),g=0,qCond||(bindECond(f[0],a),a=!1,g=1),e=g;e<f.length;e++)bindECond(f[e],a)}else{for(e=0;e<ddlQuery.options.length;e++)if(h=ddlQuery.options[e].text,isSample(h)){ddlQuery.selectedIndex=e;break}ddlQuery.onchange()}}function bindECond(a,b){var h,i,c=a.split("┋"),d="",e=c[1],f=c[2],g=c[3];switch(c[0]){case"1":d="提交答卷日期";break;case"3":d="填写所用时间";break;case"4":d="填写序号";break;case"5":d="分数";break;case"7":d="省份",e=f,f="",g="";break;case"8":d="来源",e=f,f="",g="";break;case"9":d="城市",e=f,f="",g="";break;case"10":d="IP地址";break;case"12":d="用户名";break;case"11":d="核销码";break;case"13":d="来源详情";break;case"14":d="完成凭证";break;case"21":d="星标",1==window.isshop&&(d="支付状态"),e=f,f="",g="";break;case"31":d="常用备注",e=f,f="",g=""}b?(ddlQuery.value=d,ddlQuery.onchange(),h=ddlQuery.spanCondition.getElementsByTagName("input"),f&&(h[0]?h[0].value=f:ddlQuery.spanCondition.getElementsByTagName("select")[0].value=f),g&&(h[1].value=g,h[1].parentNode.style.display=""),e&&(i=ddlQuery.spanCondition.getElementsByTagName("select")[0],i.value=e,i.onchange&&i.onchange())):addQuery(d,e,f,g)}function delQuery(a,b){return 1==ddlQueries.length?(divQueryMsg.innerHTML="必须要保留一个查询条件",void 0):(ddlQuery.parentNode.parentNode.parentNode.removeChild(a),ddlQueries.remove(b),b==ddlQuery&&(ddlQuery=ddlQueries[0]),void 0)}function addQuery(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p;return ddlQueries.length>=queryCount?(divQueryMsg.innerHTML="最多只允许"+queryCount+"个查询条件",2==queryCount&&(divQueryMsg.innerHTML+=window.isVip?"，<a href='/newwjx/manage/purchase.aspx' target='_blank'>购买企业版服务</a>允许4个查询条件":"，<a href='/register/upgradevip.aspx?upgradeReason=62' target='_blank'>升级并购买企业版</a>允许4个查询条件"),void 0):(divQueryMsg.innerHTML="",e=document.createElement("div"),e.className="condition-cont",f=ddlQuery.cloneNode(!0),f.onchange=showCondition,g=document.createElement("span"),e.appendChild(g),h=ddlQueries.length,i=ddlQueries[h-1].selectedIndex,j=0,i+1<ddlQuery.options.length?j=i+1:i-1>0&&(j=i-1),f.selectedIndex=j,a&&(f.value=a),g.appendChild(f),g.appendChild(document.createTextNode(" ")),k=document.createElement("span"),e.appendChild(k),l=btnAddQuery.cloneNode(!0),l.onclick=addQuery,f.btnAddQuery=l,f.spanCondition=null,m=btnDelQ.cloneNode(!0),m.onclick=function(){delQuery(e,f)},k.appendChild(m),f.btnDelteQuery=m,n=document.createElement("div"),n.style.clear="both",e.appendChild(n),ddlQuery.parentNode.parentNode.parentNode.appendChild(e),ddlQueries.push(f),parseInt(a)==a?b instanceof Array?BindQsQuestionData(f,b):BindQsChoiceData(f,b):(f.onchange(),o=f.spanCondition.getElementsByTagName("input"),o[0]&&(o[0].value=c||""),o[1]&&(o[1].value=d||"",d&&(o[1].parentNode.style.display="")),b&&(p=f.spanCondition.getElementsByTagName("select")[0],p.value=b,p.onchange&&p.onchange())),void 0)}function isInt(a){return parseInt(a)==a}function isDate(a){var d,e,b=/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/,c=a.match(b);return null==c?!1:(d=new Date(c[1],c[3]-1,c[4]),e=d.getFullYear()+c[2]+(d.getMonth()+1)+c[2]+d.getDate(),e==a)}function checkData(){var a=this.checkType;switch(a){case"省份":break;case"来源":break;case"城市":break;case"星标":case"支付状态":break;case"IP地址":case"核销码":case"完成凭证":case"用户名":case"来源详情":break;case"提交答卷日期":isDate(this.value)||(this.value="",divQueryMsg.innerHTML="必须为日期(如2010-1-1)");break;case"填写序号":break;case"填写所用时间":case"分数":isInt(this.value)||(this.value="",divQueryMsg.innerHTML="必须为整数")}}function getQueryCond(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,a="",b="";for(queryName="",c=0,d=0,e=new Object,f=0;f<ddlQueries.length;f++)if(g=ddlQueries[f].value,!e[g])if(e[g]="1",parseInt(g)==g){if(c>0&&(a+="〒"),h="",htQuestion[g])i=ddlQueries[f].spanCondition.getElementsByTagName("input"),j=i[0],k=ddlQueries[f].spanCondition.getElementsByTagName("select")[0],l="",j.value&&(l=g+"§"+j.value+"§"+k.value),"2"==htQuestion[g]&&(l+=";1"),"2"==htQuestion[g]&&"3"==k.value&&(i[1].value?l+="§"+i[1].value:l=""),a+=l;else{if(htCheckQs[g])for(m=ddlQueries[f].spanCondition.getElementsByTagName("input"),n=0,o=0;o<m.length;o++)p=m[o],p.checked&&(n>0&&(h+="┋"),h+=p.value,n++);else q=ddlQueries[f].spanCondition.getElementsByTagName("select")[0],h=q.value,queryName+=q.options[q.selectedIndex].text;a+=g+","+h}c++}else{switch(d>0&&(b+="〒"),q=ddlQueries[f].spanCondition.getElementsByTagName("select")[0],q&&(r=q.selectedIndex),s=ddlQueries[f].spanCondition.getElementsByTagName("input"),t=s[0],u=s[1],g){case"省份":b+="7┋0┋"+q.value,queryName+=q.value;break;case"常用备注":q&&(b+="31┋0┋"+q.value,queryName+=q.value);break;case"来源":b+="8┋0┋"+q.value,queryName+=q.value;break;case"城市":b+="9┋0┋"+q.value,queryName+=q.value;break;case"IP地址":b+="10┋0┋"+t.value;break;case"核销码":b+="11┋0┋"+t.value;break;case"完成凭证":b+="14┋0┋"+t.value;break;case"用户名":b+="12┋0┋"+t.value;break;case"星标":case"支付状态":b+="21┋0┋"+ddlStar.value;break;case"来源详情":b+="13┋0┋"+t.value;break;case"提交答卷日期":b+="1┋"+r+"┋"+t.value+"┋"+u.value;break;case"填写所用时间":b+="3┋"+r+"┋"+t.value+"┋"+u.value;break;case"填写序号":b+="4┋"+r+"┋"+t.value+"┋"+u.value;break;case"分数":b+="5┋"+r+"┋"+t.value+"┋"+u.value}d++}return a=encodeURIComponent(a),b=encodeURIComponent(b),[a,b]}var queryName,htCheckQs=new Object,htQuestion=new Object;ddlSaveQuery&&(ddlSaveQuery.onchange=function(){this.value&&(window.location=this.value),btnDelQuery.style.display=this.value?"":"none",btnShareReport.style.display=this.value?"":"none"}),btnDelQuery&&(btnDelQuery.style.display=ddlSaveQuery.value?"":"none",btnDelQuery.onclick=function(){var a="/wjx/report/deletereport.aspx?activity="+activityId+"&reportid="+reportid;confirm("此操作无法恢复，确认删除吗？")&&PDF_launch(a,400,100)}),btnShareReport&&(btnShareReport.style.display=ddlSaveQuery.value?"":"none",btnShareReport.onclick=function(){return isVip?(PDF_launch("/wjx/ActivityStat/shareviewsummary.aspx?activity="+activityId+"&reportid"+reportid,720,520),void 0):(alert("很抱歉，此功能只对企业版用户开放"),void 0)}),queryName="",document.onclick=function(){window.calendar&&calendar.hide()},initQuery();